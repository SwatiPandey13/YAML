steps:
- script: |
    echo "Starting sparse checkout process..."
    mkdir -p snyk-config
    cd snyk-config
    
    # Initialize repo with debug output
    git init --initial-branch=main
    git config core.sparseCheckout true
    
    # Verify remote URL
    REMOTE_URL="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_git/snyk-policy-config"
    echo "Using repository URL: $REMOTE_URL"
    git remote add origin "$REMOTE_URL"
    
    # Set up sparse checkout
    echo "Configuring sparse checkout paths..."
    echo "SAST_configs/" > .git/info/sparse-checkout
    echo "SCA_configs/" >> .git/info/sparse-checkout
    
    # Perform the pull with authentication and debug
    echo "Pulling files..."
    git -c http.extraHeader="Authorization: Bearer $(System.AccessToken)" pull origin main --depth=1
    
    # Debug: Show pulled files
    echo "Contents after pull:"
    ls -la
    
    # Verify directories exist before copying
    if [ -d "./SAST_configs" ] && [ -d "./SCA_configs" ]; then
      echo "Copying config files..."
      cp -a ./SAST_configs ../
      cp -a ./SCA_configs ../
      echo "Copy completed successfully"
    else
      echo "##vso[task.logissue type=error]Required directories not found after pull!"
      echo "Current directory contents:"
      ls -la
      exit 1
    fi
  displayName: 'Sparse checkout via script'
  env:
    GIT_TERMINAL_PROMPT: 0
