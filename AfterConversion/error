steps:
- script: |
    echo "Starting sparse checkout process..."
    mkdir -p snyk-config
    cd snyk-config
    
    # Initialize fresh repo
    git init --initial-branch=main
    git config core.sparseCheckout true
    
    # Verified remote URL format
    REMOTE_URL="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_git/snyk-policy-config"
    echo "Using repository URL: $REMOTE_URL"
    git remote add origin "$REMOTE_URL"
    
    # Configure sparse checkout (try both variants)
    echo "SAST_configs" > .git/info/sparse-checkout
    echo "SCA_configs" >> .git/info/sparse-checkout
    
    # Perform the pull with full debugging
    echo "Fetching content..."
    git -c http.extraHeader="Authorization: Bearer $(System.AccessToken)" fetch --depth=1 origin main
    echo "Checking out files..."
    git checkout FETCH_HEAD
    
    # Enhanced debugging
    echo "Repository contents after checkout:"
    find . -type d -print
    echo "SAST_configs contents:"
    ls -la SAST_configs/ || echo "SAST_configs not found"
    echo "SCA_configs contents:"
    ls -la SCA_configs/ || echo "SCA_configs not found"
    
    # Robust copy with verification
    if [ -d "SAST_configs" ] && [ -d "SCA_configs" ]; then
      echo "Copying config files..."
      cp -rv SAST_configs ../
      cp -rv SCA_configs ../
      echo "##[section]Successfully copied config files"
    else
      echo "##vso[task.logissue type=error]CRITICAL: Config directories missing!"
      echo "##[debug]Current directory structure:"
      find . -type d -print
      exit 1
    fi
  displayName: 'Sparse checkout snyk-config'
  env:
    GIT_TERMINAL_PROMPT: 0
