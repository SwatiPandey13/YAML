steps:
# Clean both Maven cache and local repository
- script: |
    mvn dependency:purge-local-repository -DactTransitively=false -DreResolve=false
    rm -rf ~/.m2/repository/org/sonarsource/scanner/maven/
  displayName: 'Clean Maven Cache'

# Run with debug to verify plugin version
- script: mvn help:effective-pom -Doutput=effective-pom.xml
  displayName: 'Verify Effective POM'

# Main build with forced Java 8 compatibility
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean verify sonar:sonar'
    options: >
      -Dsonar.projectKey=$(SONAR_PROJECT_KEY)
      -Dsonar.projectName=$(SONAR_PROJECT_KEY)
      -Dsonar.host.url=$(SONARQUBE_URL)
      -Dsonar.login=$(SONAR_TOKEN)
      -Dsonar.java.binaries=target/classes
      -Dsonar.sourceEncoding=UTF-8
      -Dsonar.scanner.metadata.skip=true
      -Dmaven.sonar.version=3.7.0.1746
    publishJUnitResults: false
  env:
    JAVA_HOME: $(JAVA_HOME_8_X64)  # Explicitly set Java 8
    SONAR_TOKEN: $(SONAR_TOKEN)
